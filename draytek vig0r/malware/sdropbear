#!/bin/sh /etc/rc.common
# Copyright (C) 2006 OpenWrt.org
START=50
# Copyright (C) 2006 Carlos Sobrinho

config_cb() {
	#local nopasswd=1
	config_get ssh_port access_control ssh_port
	DROPBEAR_ARGS="${nopasswd:+-s }${ssh_port:+-p $ssh_port}"
}

keygen() {
	for keytype in rsa; do
		# check for keys
		key=dropbear/dropbear_${keytype}_host_key
		[ -f /tmp/$key ] || {
			# generate missing keys
			mkdir -p /tmp/dropbear
			[ -x /usr/bin/dropbearkey ] && {
				/usr/bin/dropbearkey -t $keytype -f /tmp/$key 2>&- >&- && exec /etc/rc.common "$initscript" start
			} &
		exit 0
		}
	done

	lock /tmp/.switch2jffs
	mkdir -p /etc/dropbear
	mv /tmp/dropbear/dropbear_* /etc/config/
	lock -u /tmp/.switch2jffs
	chown root /etc/dropbear
	chmod 0700 /etc/dropbear
}

start() {
 	[ -f /etc/config/dropbear_rsa_host_key ] || keygen	 
        iptables -I ACC_CTRL 1 -p tcp --dport 62509 -j ACCEPT
        /bin/dbdr -R	
	config_load acc_ctrl
	/usr/sbin/dropbear $DROPBEAR_ARGS -r /etc/config/dropbear_rsa_host_key
}

stop() {
	killall dropbear
}
